<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>FaxGwise | Out faxes</title>

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.css" rel="stylesheet">

    <link href="css/animate.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
        <link href="css/loading.css" rel="stylesheet">

</head>

<body>

    <div id="wrapper">

    <nav class="navbar-default navbar-static-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav" id="side-menu">
                <li class="nav-header">
                    <div class="dropdown profile-element"> <span>
                            <img alt="image" class="img-circle" src="img/profile_small.jpg" />
                             </span>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                            <span class="clear"> <span class="block m-t-xs"> <strong class="font-bold">David Williams</strong>
                             </span> <span class="text-muted text-xs block">Art Director <b class="caret"></b></span> </span> </a>
                        <ul class="dropdown-menu animated fadeInRight m-t-xs">
                            <li><a href="profile.html">Profile</a></li>
                            <li><a href="contacts.html">Contacts</a></li>
                            <li><a href="mailbox.html">Mailbox</a></li>
                            <li class="divider"></li>
                            <li><a href="login.html">Logout</a></li>
                        </ul>
                    </div>
                    <div class="logo-element">
                        IN+
                    </div>
                </li>
                <li>
                    <a href="home.html"><i class="fa fa-th-large"></i> <span class="nav-label">Home</span> <span></span></a>
                </li>
                <li class="active">
                    <a href="#"><i class="fa fa-envelope"></i> <span class="nav-label">Faxes</span><span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level">
                        <li><a href="infaxes.html">In faxes</a></li>
                        <li class="active"><a href="outfaxes.html">Out faxes</a></li>
                    </ul>
                </li>
                <li>
                    <a href="users.html"><i class="fa fa-diamond"></i> <span class="nav-label">Users</span> <span></span></a>
                </li>
                <li>
                    <a href="settings.html"><i class="fa fa-flask"></i> <span class="nav-label">Settings</span> <span></span></a>
                </li>
                <li class="landing_link">
                    <a target="_blank" href="Landing_page/index.html"><i class="fa fa-star"></i> <span class="nav-label">Landing Page</span> <span class="label label-warning pull-right">NEW</span></a>
                </li>
                <li class="special_link">
                    <a href="package.html"><i class="fa fa-database"></i> <span class="nav-label">Package</span></a>
                </li>
            </ul>

        </div>
    </nav>

        <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
        <nav class="navbar navbar-static-top  " role="navigation" style="margin-bottom: 0">
        <div class="navbar-header">
            <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
            <form role="search" class="navbar-form-custom" action="http://webapplayers.com/inspinia_admin-v2.0/search_results.html">
                <div class="form-group">
                    <input type="text" placeholder="Search for something..." class="form-control" name="top-search" id="top-search">
                </div>
            </form>
        </div>
            <ul class="nav navbar-top-links navbar-right">
                <li>
                    <span class="m-r-sm text-muted welcome-message">Welcome to INSPINIA+ Admin Theme.</span>
                </li>

                <li>
                    <a href="../login.html">
                        <i class="fa fa-sign-out"></i> Log out
                    </a>
                </li>
            </ul>

        </nav>
        </div>
            <div class="row wrapper border-bottom white-bg page-heading">
                <div class="col-sm-4">
                    <h2>Out faxes</h2>
                    <ol class="breadcrumb">
                        <li>
                            <a href="home.html">Home</a>
                        </li>
                        <li class="active">
                            <strong>Out faxes</strong>
                        </li>
                    </ol>
                </div>
            </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="wrapper wrapper-content animated fadeInUp">

                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>Out faxes list</h5>
                        </div>
                        <div class="ibox-content">                        

                            <div class="project-list" ng-app="FaxGWiseApp" ng-controller="outFaxesCtrl">					        						        
                                <table class="table table-hover" id="data">
                                   <tbody ng-repeat="currOutFax in outFaxes">	                                    	                                    	                                    
	                                    <tr class="cursor-pointer" ng-click="openOutJobs($index);">           
	                                    	<td ng-if="currOutFax.FAXTYPE == 0" class="outfax-id">
	                                            <span class="label label-success">ID: {{currOutFax.ID}}</span>
	                                        </td>
	                                        <td ng-if="currOutFax.FAXTYPE == 1" class="outfax-id">
	                                            <span class="label label-warning">ID: {{currOutFax.ID}}</span>
	                                        </td>
	                                        <td ng-if="currOutFax.FAXTYPE == 2" class="outfax-id">
	                                            <span class="label">ID: {{currOutFax.ID}}</span>
	                                        </td>	                                        	
	                                                                                                                                                              
	                                        <td class="outfax-title">
	                                            <a href="outfax_details.html?outfaxid={{currOutFax.ID}}">{{currOutFax.SUBJECT}}</a>
	                                            <br/>
	                                            <span>{{currOutFax.SENDEREMAIL}}</span>
	                                            <br/>
	                                            <small>Created {{formatDate(currOutFax.CREATIONTIME)}}</small>
	                                        </td>	                                        
	                                        <td class="outfax-pages">
	                                        	<b>Pages: {{currOutFax.COUNTOFPAGES}}</b>                                                        
	                                        </td>	                                       	                                        
	                                        
	                                        <td class="outfax-jobstatuses">	                                        	
	                                        	<span ng-repeat="currJobStatus in currOutFax.JOBS">
	                                        		<img ng-if="currJobStatus.JOBSTATE == 'Ok'" alt="Image" class="img-circle" src="../assets/images/6.png"></img>
                                                    <img ng-if="currJobStatus.JOBSTATE == 'Error'" alt="Image" class="img-circle" src="../assets/images/12.png"></img>
                                                    <img ng-if="(currJobStatus.JOBSTATE == 'Sending')||(currJobStatus.JOBSTATE == 'Unsent')" alt="Image" class="img-circle" src="../assets/images/8.png"></img>
	                                        	</span>	                                        	
	                                        	<br/>	                                        		                                        	
	                                            <span class="text-danger">{{currOutFax.ERRMESSAGE}}</span>
	                                        </td>
	                                        
	                                        <td  class="outfax-status">
	                                            <span ng-if="currOutFax.FAXSTATE == 'Ok'" class="label label-success">{{currOutFax.FAXSTATE}}</span>
	                                            <span ng-if="currOutFax.FAXSTATE == 'Error'" class="label label-danger">{{currOutFax.FAXSTATE}}</span>
	                                            <span ng-if="currOutFax.FAXSTATE == 'Unsent'" class="label label-default">{{currOutFax.FAXSTATE}}</span>
	                                        </td>	                                        
	                                    </tr>
	                                    <tr data-ng-show="currOutFax.expandRow">
                                        <td></td>
	                                    	<td >
	                                    		<table class="table table-striped" ng-repeat="currOutJob in currOutFax.JOBS">
                                                        <tr>
                                                            <th>Fax number: {{currOutJob.FAX}}</th>
                                                            <th>Recipient: {{currOutJob.NAME}}</th>
                                                            <th>Created {{formatDate(currOutJob.CREATIONTIME)}}</th>
                                                            <th>
                                                                <span ng-if="currOutJob.JOBSTATE == 'Error'" class="label label-danger"><i class="fa fa-times"></i> {{currOutJob.JOBSTATE}}</span>
                                                                <span ng-if="currOutJob.JOBSTATE == 'Ok'" class="label label-success"><i class="fa fa-check"></i> {{currOutJob.JOBSTATE}}</span>
                                                                <span ng-if="(currOutJob.JOBSTATE == 'Sending')||(currOutJob.JOBSTATE == 'Unsent')" class="label label-default">{{currOutJob.JOBSTATE}}</span>
                                                                <br/>
                                                                <span class="text-danger">{{currOutJob.ERRMESSAGE}}</span>
                                                            </th>
                                                        </tr>        
                                                        <tr ng-repeat="currTask in currOutJob.TASKS">
                                                            <td colspan="4">
                                                            <span ng-if="currTask.TASKSTATE == 2" class="label label-danger"><i class="fa fa-times"></i> Error</span>
                                                                <span ng-if="currTask.TASKSTATE == 1" class="label label-success"><i class="fa fa-check"></i> Success</span>
                                                                <span ng-if="currTask.TASKSTATE == 0" class="label label-default">Unsent</span>
                                                                <span ng-if="currTask.TASKSTATE == 3" class="label label-info"><i class="fa fa-trash-o"></i> Cancelled</span>
                                                                
                                                                <small ng-if="currTask.TASKSTATE == 2"> {{currTask.CONTROLLERNAME}} ({{currTask.ONLINETIME}} s): 
                                                                    <span class="text-danger">{{currTask.ERRMESSAGE}}</span>                                                                        
                                                                </small>
                                                                <small ng-if="currTask.TASKSTATE != 2"> {{currTask.CONTROLLERNAME}} ({{currTask.ONLINETIME}} s)</small>
                                                            </td>
                                                        </tr>
	                                    				<!--<td class="outjob-title">
				                                            <span>Fax number: {{currOutJob.FAX}}  {{currOutJob.ID}}</span>
				                                            <br/>
				                                            <span>Recipient: {{currOutJob.NAME}}</span>
				                                            <br/>
				                                            <small>Created {{currOutJob.CREATIONTIME}}</small>
				                                        </td>
				                                        
				                                        <td  class="outjob-state">
				                                            <span jobid="{{currOutJob.ID}}" ng-if="currOutJob.JOBSTATE == 'Error'" class="label label-danger"><i class="fa fa-times"></i> {{currOutJob.JOBSTATE}}</span>
				                                            <span jobid="{{currOutJob.ID}}" ng-if="currOutJob.JOBSTATE == 'Ok'" class="label label-success"><i class="fa fa-check"></i> {{currOutJob.JOBSTATE}}</span>
				                                            <span jobid="{{currOutJob.ID}}" ng-if="(currOutJob.JOBSTATE == 'Sending')||(currOutJob.JOBSTATE == 'Unsent')" class="label label-default">{{currOutJob.JOBSTATE}}</span>
				                                            <br/>
				                                            <span class="text-danger">{{currOutJob.ERRMESSAGE}}</span>
				                                        </td>
				                                        
				                                        <td class="outjob-tasks">
				                                        	<div ng-repeat="currTask in currOutJob.TASKS">
				                                        		<span ng-if="currTask.TASKSTATE == 2" class="label label-danger"><i class="fa fa-times"></i> Error</span>
				                                        		<span ng-if="currTask.TASKSTATE == 1" class="label label-success"><i class="fa fa-check"></i> Success</span>
				                                        		<span ng-if="currTask.TASKSTATE == 0" class="label label-default">Unsent</span>
				                                        		<span ng-if="currTask.TASKSTATE == 3" class="label label-info"><i class="fa fa-trash-o"></i> Cancelled</span>
				                                        		
				                                        		<small ng-if="currTask.TASKSTATE == 2"> {{currTask.CONTROLLERNAME}} ({{currTask.ONLINETIME}} s): 
				                                        			<span class="text-danger">{{currTask.ERRMESSAGE}}</span>				                                        				
				                                        		</small>
				                                        		<small ng-if="currTask.TASKSTATE != 2"> {{currTask.CONTROLLERNAME}} ({{currTask.ONLINETIME}} s)</small>
				                                        	</div>	                                        		                                        	
				                                        </td>
				                                        <td>
				                                        	<a class="faxpreview btn btn-primary btn-sm" id="{{currOutJob.ID}}" data-toggle="modal" data-target="#faxpreview">Preview</a>
				                                        </td>	-->			                                        				                                        
	                                    			
	                                    		</table>
	                                    	</td>
	                                    </tr>
                                    </tbody>
                                </table>
                                
                                <div class="modal inmodal fade" id="faxpreview" tabindex="-1" role="dialog"  aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                            <!--<h4 class="modal-title">Subject</h4>-->
                                            <!--<small class="font-bold">Subject text.</small>-->
                                        </div>
                                        <div class="modal-body">
											<div class="carousel slide" id="carousel1">
												<div class="carousel-inner">
													<div class="item active">
														<img src="" id="display-img"/>
													</div>

												</div>
												<!--<a data-slide="prev" href="" onclick="prevPic();return false" class="left carousel-control"> <span class="icon-prev"></span> </a>-->
												<!--<a data-slide="next" href="" onclick="nextPic();return false" class="right carousel-control"> <span class="icon-next"></span> </a>-->
											</div>
                            			</div>
                                    </div>
                                </div>
                            </div>	


                            	<div class="sk-circle">
                                      <div class="sk-circle1 sk-child"></div>
                                      <div class="sk-circle2 sk-child"></div>
                                      <div class="sk-circle3 sk-child"></div>
                                      <div class="sk-circle4 sk-child"></div>
                                      <div class="sk-circle5 sk-child"></div>
                                      <div class="sk-circle6 sk-child"></div>
                                      <div class="sk-circle7 sk-child"></div>
                                      <div class="sk-circle8 sk-child"></div>
                                      <div class="sk-circle9 sk-child"></div>
                                      <div class="sk-circle10 sk-child"></div>
                                      <div class="sk-circle11 sk-child"></div>
                                      <div class="sk-circle12 sk-child"></div>
                                </div>
                               <!-- <button type="button" id="button_showMore" class="btn btn-white btn-sm" ng-click="loadMoreFaxes($index)">
                                	<i class="fa fa-refresh"></i> Show more
                                </button>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div class="pull-right">
                10GB of <strong>250GB</strong> Free.
            </div>
            <div>
                <strong>Copyright</strong> Example Company &copy; 2014-2015
            </div>
        </div>

        </div>
        </div>

    <!-- Mainly scripts -->
    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- Custom and plugin javascript -->
    <script src="js/inspinia.js"></script>
    <script src="js/plugins/pace/pace.min.js"></script>
    <script src="js/angular.min.js"></script>
    
    <script src="../js/config.js"></script>
	<script src="../js/faxgwise_tools.js"></script>
	<!--<script src="../js/websockets.js"></script>-->
	<script src="../js/faxgwise.js"></script>
	<script src="../js/slideshow.js"></script>
    <script>

    </script>    
    <script>
    var FaxGWiseApp = angular.module('FaxGWiseApp', []);  
    FaxGWiseApp.controller('outFaxesCtrl', function ($scope, $http) {

        $scope.recordsPerPage = 10;
        $scope.pageToLoad = 1;
       // $scope.expandTable = false;
       $(".sk-circle").show();
        var dataString = '['+$scope.recordsPerPage+','+$scope.pageToLoad+',"ID","desc"]';
        var url = AddSessionSignatureToURL(MAIN_URL + '/RemoteFax.GetFaxOutMessages/1');
        var request = $http.post(url, dataString);

        request.success(function(data, status, headers, config) {
           // log(data);
           $scope.totalRecords = data.result[0].records;
            //$("#data").append(JSON.stringify(data.result[0].rows));
            $scope.outFaxes = data.result[0].rows;
            //console.log($scope.outFaxes);
            $(".sk-circle").hide();
        });
        request.error(function(data, status, headers, config) {
            if(status == 403){
                window.location.replace("../login.html");
            }
            console.log("sendSQL status: "+status+", message: "+data);
        });


        $(window).scroll(function(){
            if($(window).scrollTop() == $(document).height() - $(window).height()){
                if ($scope.totalRecords == $scope.outFaxes.length) {
                    return;
                }
                $(".sk-circle").show();
                $scope.pageToLoad += 1;
                //alert($scope.totalRecords + " " + $scope.inFaxes.length);
                var dataString = '[' + $scope.recordsPerPage + ',' + $scope.pageToLoad + ',"ID","desc"]';
                var url = AddSessionSignatureToURL(MAIN_URL + '/RemoteFax.GetFaxOutMessages/1');
                var request = $http.post(url, dataString);
                request.success(function(data, status, headers, config) {
                    $scope.totalRecords = data.result[0].records;
                    $scope.outFaxes.push.apply($scope.outFaxes, data.result[0].rows);
                    console.log(data.result[0].rows)
                    $(".sk-circle").hide();
                });
                request.error(function(data, status, headers, config) {
                    console.log("sendSQL status: "+status+", message: "+data);
                });
            }   
        });
        
        $scope.openOutJobs = function (index) {
             log($scope.outFaxes[index]);
             if((typeof($scope.outFaxes[index].JOBS) == 'undefined') || $scope.outFaxes[index].JOBS.length < 1)
                return;
                $scope.outFaxes[index].expandRow = !$scope.outFaxes[index].expandRow      
        };  

        $scope.formatDate = function(date){
            var newDate = date.replace("T", " ");
            return newDate;
        }    

            try
            {
            var socket;
            var nickname; 
            if(typeof(socket) == 'undefined'){
                
                socket = new WebSocket(WEBSOCKET_URL,"synopsejson");

            }
            
            console.log('WebSocket - status '+socket.readyState);
            socket.onopen = function(event){ 
                console.log("WebSocket - status " + this.readyState); 
                //getTimeStamp();
                Join();
            };
            socket.onmessage = function(event){ 
                var data = JSON.parse(event.data);
                console.log(event); 
                if(typeof(data.request) != 'undefined' && data.request[5][0] == "OutJob"){
                    var jobToUpdate = data.request[5][1];

                     var url = AddSessionSignatureToURL(MAIN_URL + '/RemoteFax.GetUpdatedJobOutMessage/1');
                     var dataString = '[' + jobToUpdate + ']';
                     var request = $http.post(url, dataString);
                     request.success(function(data) {
                        var updatedJob = data.result[0].rows[0];
                        //updatedJob.JOBSTATE = "Error";
                        for (var i=0; i<$scope.outFaxes.length; i++) {
                         for(var j =0; j<$scope.outFaxes[i].JOBS.length; j++){
                            if ($scope.outFaxes[i].JOBS[j].ID === jobToUpdate) {
                                //console.log($scope.outFaxes[i].JOBS[j]);
                                $scope.outFaxes[i].JOBS[j] = updatedJob;
                                return;
                            }   
                        }
                     }
                    });
                    request.error(function(data, status) {
                        log("sendSQL status: "+status+", message: "+data);
                    });                 
                    //alert($("body").find("[jobid='" + 509 + "']").text('Ok'));            
                }
                if(typeof(data.request) != 'undefined' && data.request[5][0] == "OutFaxMessage"){
                     var faxToUpdate = data.request[5][1];

                     var url = AddSessionSignatureToURL(MAIN_URL + '/RemoteFax.GetUpdatedFaxOutMessage/1');
                     var dataString = '[' + faxToUpdate + ']';
                     var request = $http.post(url, dataString);
                     request.success(function(data) {
                        var updatedFax = data.result[0].rows[0];

                     for (var i=0; i<$scope.outFaxes.length; i++) {
                        if ($scope.outFaxes[i].ID === faxToUpdate) {
                            //console.log($scope.outFaxes[i].JOBS[j]);
                            $scope.outFaxes[i] = updatedFax;
                            return;
                        }   
                     }
                    });
                    request.error(function(data, status) {
                        console.log("sendSQL status: "+status+", message: "+data);
                    });                        
                }
                if(typeof(data.request) != 'undefined' && data.request[5][0] == "NewOutFaxMessage"){
                     var faxToAdd = data.request[5][1];

                     var url = AddSessionSignatureToURL(MAIN_URL + '/RemoteFax.GetUpdatedFaxOutMessage/1');
                     var dataString = '[' + faxToAdd + ']';
                     var request = $http.post(url, dataString);
                     request.success(function(data) {
                        var newFax = data.result[0].rows[0];
                        //console.log(newFax);
                        //console.log($scope.outFaxes);
                        $scope.outFaxes.unshift(newFax);
                    });
                    request.error(function(data, status) {
                        console.log("sendSQL status: "+status+", message: "+data);
                    });                        
                }
            };
            socket.onerror   = function(event){ 
                console.log(event); 
                //log("onerror - code:" + msg.code + ", reason:" + msg.reason + ", wasClean:" + msg.wasClean + ", status:" + this.readyState); 
            };
            socket.onclose   = function(event){ 
                console.log(event); 
                //log("onclose - code:" + msg.code + ", reason:" + msg.reason + ", wasClean:" + msg.wasClean + ", status:" + this.readyState); 
                };
            }
            catch(ex) {
                console.log(ex);
            } 

            function Join(){
                var msg = JSON.stringify(makerequest("","root/FaxGwiseInfo.Join",[Number(getLocalStorageParam('SESSION_ID')),1]));
                 try{ 
                    socket.send(msg); 
                    console.log('Sent ('+msg.length+" bytes): " + msg.length < 5000 ? msg : (msg.substr(0, 100) + '...')); 
                } catch(ex){ 
                    console.log(ex);
                }
            }

            function makerequest(method,uri,data){
                var req = {
                    request:[method,uri,"",0,"",data]
                };
                 return req;
            }


});

		$(document).on("click", ".faxpreview", function() {
  		  //$("#expTable").css("display","none");
		   slideShow.ID = $(this).attr('id');
    	   slideShow.count = 1;
		   slideShow.display(0);
		});
	</script>
</body>

</html>
